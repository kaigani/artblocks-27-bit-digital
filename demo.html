<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<title>27-Bit Digital</title>
		<!-- AUTHOR: Kaigani - 2020 -->

		<!-- mobile viewport: -->
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"/>
		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

		<!-- ARTWORK CODE HERE -->
        <script src="drawToken.js"></script> 
		<script>

            // shim layer with setTimeout fallback - doesn't seem to outperform setInterval though...
			window.requestAnimFrame = (function(){
			  return  window.requestAnimationFrame       ||
			          window.webkitRequestAnimationFrame ||
			          window.mozRequestAnimationFrame    ||
			          function( callback ){
			            window.setTimeout(callback, 10000 / 60)
			          }
			})()

			window.addEventListener('resize', handleResize, false)
            window.addEventListener('load', update, false)

            function handleResize(){
                let canvas = document.getElementById('myCanvas')
                canvas.width = document.body.clientWidth
                canvas.height = document.body.clientHeight
                update()
			}

            function runLoop(){
                // Control FPS
                this.timestamp = (this.timestamp)?this.timestamp:Date.now()
                var newTimestamp = Date.now()
                var debouncePass = ((newTimestamp - this.timestamp) > 300) // 1s delay

                if(debouncePass){
                    this.timestamp = newTimestamp

                    // UPDATE 
                    update()
                
                }

                requestAnimFrame(runLoop) // for animation
            }
			
			function update() {
				
				const canvas = document.getElementById('myCanvas')
                const c = canvas.getContext('2d')
                c.webkitImageSmoothingEnabled = false

				canvas.width = document.body.clientWidth
				canvas.height = document.body.clientHeight

                // SEED - to be generated by ARTBLOCKS -- 
                // random seed - needs minimum of 27 bits - 0xfffffff
				let seed = parseInt(Math.random()*0xffffffffffff)
				let colorSeed = seed & 0xfff // first 12 bits
				let segmentSeed = (seed & 0x7f000) >> 12 // next 7 bits, shifted 12 bits
				let rarity = ((seed >> 19) & 0xff) === 1 ? 5 : ((seed >> 19) & 0xf) === 1 ? 3 : 4 
				console.log(`FROM ${seed}: ${colorSeed},${segmentSeed},${(seed >> 19) & 0xff}`)

				// NON-RANDOM VALUES FOR TESTING

				// TEST RARITY

				//rarity = 5 // LoRes (Very Rare)
				//rarity = 3 // HiRes (Rare)
				//rarity = 4 // VGA (Common)

				// TEST COLORS 
				//colorSeed = 4095 // whiteout
				//colorSeed = 0 // blackout, binary
				//colorSeed = (5<<9)+(5<<6)+(5<<3)+5 // solid
				//colorSeed = (7<<9)+(7<<6)+(7<<3) // black & white, pointillist
				//colorSeed = (3<<9)+(3<<6)+(3<<3)+1 // pointillist
				//colorSeed = (5<<9)+(3<<6)+(5<<3)+3 // bars
				//colorSeed = (5<<9)+(5<<6)+(3<<3)+3 // stripes
				//colorSeed = (2<<9)+(2<<6) // scanlines
				//colorSeed = (2<<3)+2 // other scanlines
				//colorSeed = (1<<9)+(4<<6)+(4<<3)+1 // checkerboard
				
				// 8 variations of highlighter
				//colorSeed = (7<<9)+(3<<6)+(6<<3)+2 // highlighter 7,3,6,2
				//colorSeed = (7<<9)+(6<<6)+(3<<3)+2 // highlighter
				//colorSeed = (3<<9)+(7<<6)+(2<<3)+6 // highlighter
				//colorSeed = (3<<9)+(2<<6)+(7<<3)+6 // highlighter
				//colorSeed = (6<<9)+(7<<6)+(2<<3)+3 // highlighter
				//colorSeed = (6<<9)+(2<<6)+(7<<3)+3 // highlighter
				//colorSeed = (2<<9)+(6<<6)+(3<<3)+7 // highlighter
				//colorSeed = (2<<9)+(3<<6)+(6<<3)+7 // highlighter
				
				//colorSeed = 2190 // test pattern

				// TEST 7-SEGMENT GLYPHS

				//segmentSeed = 0 // Ghost

				//segmentSeed = 0x3f // A
				//segmentSeed = 0x7a // b
				//segmentSeed = 0x53 // C
				//segmentSeed = 0x7c // d
				//segmentSeed = 0x5b // E
				//segmentSeed = 0x1b // F
				//segmentSeed = 0x3a // h
				//segmentSeed = 0x12 // I, l, 1 * alphanumeric
				//segmentSeed = 0x24 // I, l, 1 * alphanumeric
				//segmentSeed = 0x74 // J
				//segmentSeed = 0x52 // L
				//segmentSeed = 0x38 // n
				//segmentSeed = 0x77 // O,0 * alphanumeric
				//segmentSeed = 0x1f // P
				//segmentSeed = 0x6b // S,5 * alphanumeric
				//segmentSeed = 0x76 // U
				//segmentSeed = 0x3e // X
				//segmentSeed = 0x6e // y

				//segmentSeed = 0x5d // 2
				//segmentSeed = 0x6d // 3
				//segmentSeed = 0x2e // 4
				//segmentSeed = 0x7b // 6
				//segmentSeed = 0x25 // 7
				//segmentSeed = 0x7f // 8 - Lucky 8
				//segmentSeed = 0x6f // 9
				//segmentSeed = 0x36 // 11

				//segmentSeed = 0x46 // OTTO

				// RE-COMPOSE SEED
				let rarityValue = rarity === 5 ? 0x1 : rarity === 3 ? 0x11 : 0 // anything else
				seed = colorSeed + (segmentSeed << 12) + (rarityValue << 19)
				console.log(`TO ${seed}: ${colorSeed},${segmentSeed},${rarityValue}\n`)

                // the token is rendered, given the canvas and the random seed 
				drawToken(canvas,seed)
				//analyze(colorSeed,segmentSeed,rarity)
				getMetadata(seed.toString(16))

            }
			
			
			function testDistribution(){

				const count = 10000000
				let result = {}

				for(i=0;i<count;i++){
					// random seed - needs minimum of 27 bits - 0xfffffff
					let seed = parseInt(Math.random()*0xffffffffffff)
					let colorSeed = seed & 0xfff // first 12 bits
					let segmentSeed = (seed & 0x7f000) >> 12 // next 7 bits, shifted 12 bits
					let rarity = ((seed >> 19) & 0xff) === 1 ? 5 : ((seed >> 19) & 0xf) === 1 ? 3 : 4 // rarest = 5, chunky (0.4%), 3, fine (6%), 4, common
				
					let o = analyze(colorSeed,segmentSeed,rarity)
					result[o.glyph] = result.hasOwnProperty(o.glyph) ? result[o.glyph]+1 : 1
					result[o.res] = result.hasOwnProperty(o.res) ? result[o.res]+1 : 1

					o.pattern.map(item=>{
						result[item] = result.hasOwnProperty(item) ? result[item]+1 : 1
					})
				}
				Object.keys(result).map(key=>{
					console.log(`${key.padEnd(24)}: \t${(result[key]/count*100)}% \t\t${parseInt(result[key]/count*1024)}/1024`)
				})
			}
	
    		function BlockElasticScroll(event) {
        		event.preventDefault();
    		}
    	</script>
		
		<style type="text/css" media="screen">
			html {
				 height: 100%;
				 overflow: hidden;
			}
			
			body {
				margin:  0px;
				padding: 0px;
				height: 100%;
				font-family: Arial, Helvetica, sans-serif;
			}
			p {
				position:fixed;
				top: 10px;
				left: 10px;
			}
            #metaControl {
                visibility:inherit;
            }
		</style>
		
	</head>
	<body ontouchmove="BlockElasticScroll(event);">
		<canvas id="myCanvas" width="100" height="100">
			Your browser doesn't include support for the canvas tag.
		</canvas>
		<p id='metaControl'><button onclick="update()">Re-roll</button> <span id='resultMsg'></span></p>
	</body>
</html>
		